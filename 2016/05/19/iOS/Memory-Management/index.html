<!DOCTYPE html>
<html lang="en">
  <head>
    
<meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>


<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">



  <meta name="description" content="Memory Management"/>




  <meta name="keywords" content="iOS, Memory-Management, A Little Boy`s Treasure" />










  <link rel="alternate" href="/atom.xml" title="A Little Boy`s Treasure">




  <link rel="shortcut icon" type="image/x-icon" href="/../public/fav.ico?v=2.6.0" />



<link rel="canonical" href="http://nic_reals.gitee.io/blog/2016/05/19/iOS/Memory-Management/"/>


<link rel="stylesheet" type="text/css" href="/css/style.css?v=2.6.0" />






  



  <script id="baidu_push">
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>









    <title> Memory Management - A Little Boy`s Treasure </title>
  </head>

  <body><div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/." class="logo">A Little Boy`s Treasure</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>

<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    
      <a href="/">
        <li class="mobile-menu-item">
          
          
            Home
          
        </li>
      </a>
    
      <a href="/archives/">
        <li class="mobile-menu-item">
          
          
            Archives
          
        </li>
      </a>
    
      <a href="/tags">
        <li class="mobile-menu-item">
          
          
            Tags
          
        </li>
      </a>
    
      <a href="/categories">
        <li class="mobile-menu-item">
          
          
            Categories
          
        </li>
      </a>
    
      <a href="/about">
        <li class="mobile-menu-item">
          
          
            About
          
        </li>
      </a>
    
  </ul>
</nav>

    <div class="container" id="mobile-panel">
      <header id="header" class="header"><div class="logo-wrapper">
  <a href="/." class="logo">A Little Boy`s Treasure</a>
</div>

<nav class="site-navbar">
  
    <ul id="menu" class="menu">
      
        <li class="menu-item">
          <a class="menu-item-link" href="/">
            
            
              Home
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/archives/">
            
            
              Archives
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/tags">
            
            
              Tags
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/categories">
            
            
              Categories
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/about">
            
            
              About
            
          </a>
        </li>
      
    </ul>
  
</nav>

      </header>

      <main id="main" class="main">
        <div class="content-wrapper">
          <div id="content" class="content">
            
  
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          Memory Management
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2016-05-19
        </span>
        
        
      </div>
    </header>

    
    
  <div class="post-toc" id="post-toc">
    <h2 class="post-toc-title">Contents</h2>
    <div class="post-toc-content">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#堆栈"><span class="toc-text">堆栈</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ARC-amp-MRC"><span class="toc-text">ARC & MRC</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#MRC"><span class="toc-text">MRC</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ARC"><span class="toc-text">ARC</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#属性标识"><span class="toc-text">属性标识</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#循环引用"><span class="toc-text">循环引用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#一个循环引用的栗子"><span class="toc-text">一个循环引用的栗子</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#weakSelf避免循环引用"><span class="toc-text">weakSelf避免循环引用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#strongSelf避免提前释放"><span class="toc-text">strongSelf避免提前释放</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#浅拷贝-amp-深拷贝"><span class="toc-text">浅拷贝&深拷贝</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#定义"><span class="toc-text">定义</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#copy-amp-amp-mutableCopy"><span class="toc-text">copy && mutableCopy</span></a></li></ol></li></ol>
    </div>
  </div>


    <div class="post-content">
      
        <!-- # Memory Management -->
<blockquote>
<p><a href="https://hit-alibaba.github.io/interview/basic/arch/Memory-Management.html" target="_blank" rel="external">内存管理基本概念</a></p>
<p><a href="https://hit-alibaba.github.io/interview/iOS/ObjC-Basic/MM.html" target="_blank" rel="external">iOS内存管理面试</a></p>
<p><a href="http://ios.jobbole.com/88708/" target="_blank" rel="external">深入理解循环引用，weakSelf，strongSelf</a></p>
</blockquote>
<h2 id="堆栈"><a href="#堆栈" class="headerlink" title="堆栈"></a>堆栈</h2><ul>
<li><p>栈：由系统自动分配，一般存放函数参数值，局部变量值等，由编译器自动创建和释放，操作方式类似数据结构中的栈，遵循先进后出原则；</p>
</li>
<li><p>堆：一般由程序员申请并指明大小，最终也由程序员释放。如果程序员不释放，程序结束时可能会由OS回收。对于堆区的管理是采用链表式管理的，操作系统有一个记录空闲内存地址的链表，当接收到程序分配内存的申请时，操作系统就会遍历该链表，遍历到一个记录的内存地址大于申请内存的链表节点，并将该节点从该链表中删除，然后将该节点记录的内存地址分配给程序；</p>
</li>
<li><p>全局区/静态区：顾名思义，全局变量和静态变量存储在这个区域。只不过初始化的全局变量和静态变量存储在一块，未初始化的全局变量和静态变量存储在一块。程序结束后由系统释放；</p>
</li>
<li><p>文字常量区：这个区域主要存储字符串常量。程序结束后由系统释放；</p>
</li>
<li><p>程序代码区：这个区域主要存放函数体的二进制代码。</p>
</li>
</ul>
<a id="more"></a>
<h2 id="ARC-amp-MRC"><a href="#ARC-amp-MRC" class="headerlink" title="ARC &amp; MRC"></a>ARC &amp; MRC</h2><h3 id="MRC"><a href="#MRC" class="headerlink" title="MRC"></a>MRC</h3><p>MRC对象操作及<code>retainCount</code>变化：</p>
<table>
<thead>
<tr>
<th style="text-align:left">对象操作</th>
<th style="text-align:left">OC中对应的方法</th>
<th style="text-align:left">retainCount 变化</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">生成并持有对象</td>
<td style="text-align:left">alloc/new/copy/mutableCopy等</td>
<td style="text-align:left"><center>    +1 </center></td>
</tr>
<tr>
<td style="text-align:left">持有对象</td>
<td style="text-align:left">retain</td>
<td style="text-align:left"><center>    +1 </center></td>
</tr>
<tr>
<td style="text-align:left">释放对象</td>
<td style="text-align:left">release</td>
<td style="text-align:left"><center>    -1 </center></td>
</tr>
<tr>
<td style="text-align:left">废弃对象</td>
<td style="text-align:left">dealloc</td>
<td style="text-align:left"><center>    - </center></td>
</tr>
</tbody>
</table>
<p>四个对象操作法则:</p>
<ul>
<li>自己生成的对象，自己持有。</li>
<li>非自己生成的对象，自己也能持有。</li>
<li>不在需要自己持有对象的时候，释放。</li>
<li>非自己持有的对象无需释放。</li>
</ul>
<p>MRC下<code>autorelease</code>使得对象在超出生命周期后能正确的被释放(通过调用release方法)。在调用 <code>release</code> 后，对象会被立即释放，而调用 <code>autorelease</code> 后，对象不会被立即释放，而是注册到 <code>autoreleasepool</code> 中，经过一段时间后 pool结束，此时调用<code>release</code>方法，对象被释放。</p>
<h3 id="ARC"><a href="#ARC" class="headerlink" title="ARC"></a>ARC</h3><p>ARC是一种自动内存管理机制，会根据引用计数自动监视对象的生存周期，通过在代码编译器自动插入内存管理代码以及一些<code>Runtime</code>优化实现自动引用计数。</p>
<h2 id="属性标识"><a href="#属性标识" class="headerlink" title="属性标识"></a>属性标识</h2><ul>
<li><code>assign</code>表示调用getter时只是一个简单的赋值，一般用于基本数据类型；</li>
<li><code>strong</code>表示属性定义了一个拥有关系，当调用setter赋值时，会将新值retain一次，旧值release，然后进行赋值；</li>
<li><code>weak</code>表示属性定义了一个非拥有关系，类似与<code>assign</code>的简单赋值，但是当属性所指向的对象被销毁时，该属性会被置为nil；</li>
<li><code>copy</code>与<code>strong</code>类似，不过在赋值时会进行<code>copy</code>操作而非<code>retain</code>,通常在需要保留某个不可变对象（NSString最常见），并且防止它被意外改变时使用;</li>
<li><code>unsafe_unretain</code>和<code>assign</code>类似表明非拥有关系，当所指向对象销毁时不会置为nil。</li>
</ul>
<h2 id="循环引用"><a href="#循环引用" class="headerlink" title="循环引用"></a>循环引用</h2><h3 id="一个循环引用的栗子"><a href="#一个循环引用的栗子" class="headerlink" title="一个循环引用的栗子"></a>一个循环引用的栗子</h3><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">typedef</span> <span class="keyword">void</span>(^Study)();</div><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Student</span> : <span class="title">NSObject</span></span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">copy</span> , <span class="keyword">nonatomic</span>) <span class="built_in">NSString</span> *name;</div><div class="line"><span class="keyword">@property</span> (<span class="keyword">copy</span> , <span class="keyword">nonatomic</span>) Study study;</div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">#import &quot;ViewController.h&quot;</div><div class="line">#import &quot;Student.h&quot;</div><div class="line"></div><div class="line">@implementation ViewController</div><div class="line"></div><div class="line">- (void)viewDidLoad &#123;</div><div class="line">    [super viewDidLoad];</div><div class="line">    Student *student = [[Student alloc]init];</div><div class="line">    student.name = @&quot;Hello World&quot;;</div><div class="line">    student.study = ^&#123;</div><div class="line">        NSLog(@&quot;my name is = %@&quot;,student.name);</div><div class="line">    &#125;;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>其中<code>student</code>拥有<code>study</code>这个block，而<code>study</code>有拥有<code>student</code>,形成了循环引用。</p>
<h3 id="weakSelf避免循环引用"><a href="#weakSelf避免循环引用" class="headerlink" title="weakSelf避免循环引用"></a>weakSelf避免循环引用</h3><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">__<span class="keyword">weak</span> <span class="keyword">typeof</span>(student) weakSelf = student;</div><div class="line">student.study = ^&#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"my name is = %@"</span>,weakSelf.name);</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p><code>__weak</code>定义了一种非拥有关系，当<code>weakSelf</code>指向的对象<code>student</code>销毁时，<code>weakSelf</code>会被置为nil，不会造成循环引用；</p>
<h3 id="strongSelf避免提前释放"><a href="#strongSelf避免提前释放" class="headerlink" title="strongSelf避免提前释放"></a>strongSelf避免提前释放</h3><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#import <span class="meta-string">"ViewController.h"</span></span></div><div class="line"><span class="meta">#import <span class="meta-string">"Student.h"</span></span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">ViewController</span></span></div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</div><div class="line">    [<span class="keyword">super</span> viewDidLoad];</div><div class="line">    Student *student = [[Student alloc]init];</div><div class="line">    student.name = <span class="string">@"Hello World"</span>;</div><div class="line">    __<span class="keyword">weak</span> <span class="keyword">typeof</span>(student) weakSelf = student;</div><div class="line">    student.study = ^&#123;</div><div class="line">        __<span class="keyword">strong</span> <span class="keyword">typeof</span>(student) strongSelf = weakSelf;</div><div class="line">        dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(<span class="number">2.0</span> * <span class="built_in">NSEC_PER_SEC</span>)), dispatch_get_main_queue(), ^&#123;</div><div class="line">            <span class="built_in">NSLog</span>(<span class="string">@"my name is = %@"</span>,strongSelf.name);</div><div class="line">        &#125;);</div><div class="line">    &#125;;</div><div class="line">    student.study();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>此时由于<code>dispatch_after</code>2秒的异步延迟，<code>student.study()</code>会先于NSLog调用，<code>student.study()</code>执行完后，<code>student</code>会被销毁，由于<code>weakSelf</code>实用<code>__weak</code>定义了非拥有关系，<code>weakSelf</code>会被置为nil，所以输出为：<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">my name is = (null)</div></pre></td></tr></table></figure></p>
<p>使用<code>__strong</code>可以避免在block生命周期内，<code>strongSelf</code>被置为nil：<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">__<span class="keyword">weak</span> <span class="keyword">typeof</span>(student) weakSelf = student;</div><div class="line">   student.study = ^&#123;</div><div class="line">       __<span class="keyword">strong</span> <span class="keyword">typeof</span>(student) strongSelf = weakSelf;</div><div class="line">       dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(<span class="number">2.0</span> * <span class="built_in">NSEC_PER_SEC</span>)), dispatch_get_main_queue(), ^&#123;</div><div class="line">           <span class="built_in">NSLog</span>(<span class="string">@"my name is = %@"</span>,strongSelf.name);</div><div class="line">       &#125;);</div><div class="line"></div><div class="line">   &#125;;</div></pre></td></tr></table></figure></p>
<p>当<code>student.study()</code>执行，由于<code>__strong</code>定义了拥有关系，<code>strongSelf</code>指向<code>student</code>对象的内存地址，并且保留了对<code>student</code>的引用，此时<code>strongSelf</code>不会被销毁，当block调用完，<code>strongSelf</code>作为临时变量被销毁，没有指针指向<code>student</code>对象，<code>student</code>也被销毁，所以也不会造成循环引用。</p>
<h2 id="浅拷贝-amp-深拷贝"><a href="#浅拷贝-amp-深拷贝" class="headerlink" title="浅拷贝&amp;深拷贝"></a>浅拷贝&amp;深拷贝</h2><h3 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h3><ul>
<li><p>浅拷贝：只是复制容器本身，不会复制容器内部的元素，浅拷贝后生成的新容器对象和原始容器对象共享内部元素；</p>
</li>
<li><p>深拷贝：不仅复制容器本身，容器内部的元素也会复制，深拷贝后生成的新容器对象和原始容器的内部元素是独立的；</p>
</li>
</ul>
<h3 id="copy-amp-amp-mutableCopy"><a href="#copy-amp-amp-mutableCopy" class="headerlink" title="copy &amp;&amp; mutableCopy"></a>copy &amp;&amp; mutableCopy</h3><ul>
<li><p>使用mutableCopy拷贝出的对象都会与被拷贝对象指向不同对象；使用copy拷贝出的对象若被拷贝对象是不可变对象，则指向同一对象，若被拷贝对象为不可变对象，则指向不同对象。</p>
</li>
<li><p>对于集合类对象，使用mutableCopy，copy操作都是浅拷贝，即使拷贝出的对象内存地址不同，但集合内部元素内存地址相同。</p>
</li>
<li><p>使用<code>initWithArray: copyItems:</code>拷贝出的对象只能实现单层深复制，完全深复制可以使用归档和解档：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">copyArray = [<span class="built_in">NSKeyedUnarchiver</span> unarchiveObjectWithData:[<span class="built_in">NSKeyedArchiver</span> archivedDataWithRootObject:array]];</div></pre></td></tr></table></figure>
</li>
<li><p>可变对象属性用copy修饰，当该对象调用setter方法赋值时，实际会先调用copy生成不可变对象，然后再赋值给该属性，该变量实际会变成不可变对象，调用可变对象方法会crash。</p>
</li>
</ul>

      
    </div>

    
      
      



      
      
    

    
      <footer class="post-footer">
        
          <div class="post-tags">
            
              <a href="/tags/iOS/">iOS</a>
            
              <a href="/tags/Memory-Management/">Memory-Management</a>
            
          </div>
        
        
        
  <nav class="post-nav">
    
      <a class="prev" href="/2016/07/09/Gear/Mac/">
        <i class="iconfont icon-left"></i>
        <span class="prev-text nav-default">Mac</span>
        <span class="prev-text nav-mobile">Prev</span>
      </a>
    
    
      <a class="next" href="/2016/05/04/iOS/MultiThread/">
        <span class="next-text nav-default">MultiThread</span>
        <span class="prev-text nav-mobile">Next</span>
        <i class="iconfont icon-right"></i>
      </a>
    
  </nav>

      </footer>
    

  </article>


          </div>
          
  <div class="comments" id="comments">
    
  </div>


        </div>
      </main>

      <footer id="footer" class="footer">

  <div class="social-links">
    
      
        
          <a href="mailto:nic.reals@outlook.com" class="iconfont icon-email" title="email"></a>
        
      
    
      
    
      
    
      
    
      
    
      
    
      
        
          <a href="https://github.com/nicreals" class="iconfont icon-github" title="github"></a>
        
      
    
      
    
      
    
      
    
      
    
      
    
      
    
    
    
      <a href="/atom.xml" class="iconfont icon-rss" title="rss"></a>
    
  </div>


<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://hexo.io/">Hexo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/ahonn/hexo-theme-even">Even</a>
  </span>

  <span class="copyright-year">
    
    &copy; 
     
      2015 - 
    
    2017

    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">Nic Reals</span>
  </span>
</div>

      </footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div>

    
  



    




  
    <script type="text/javascript" src="/lib/jquery/jquery-3.1.1.min.js"></script>
  

  
    <script type="text/javascript" src="/lib/slideout/slideout.js"></script>
  

  


    <script type="text/javascript" src="/js/src/even.js?v=2.6.0"></script>
<script type="text/javascript" src="/js/src/bootstrap.js?v=2.6.0"></script>

  </body>
</html>
